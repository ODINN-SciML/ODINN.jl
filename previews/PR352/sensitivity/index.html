<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Sensitivity analysis · ODINN.jl</title><meta name="title" content="Sensitivity analysis · ODINN.jl"/><meta property="og:title" content="Sensitivity analysis · ODINN.jl"/><meta property="twitter:title" content="Sensitivity analysis · ODINN.jl"/><meta name="description" content="Documentation for ODINN.jl."/><meta property="og:description" content="Documentation for ODINN.jl."/><meta property="twitter:description" content="Documentation for ODINN.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="ODINN.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ODINN.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../quick_start/">Quick start</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../forward_simulation/">Forward simulation</a></li><li><a class="tocitem" href="../functional_inversion/">Functional inversion</a></li><li><a class="tocitem" href="../laws/">Laws</a></li></ul></li><li><span class="tocitem">How to use ODINN</span><ul><li><a class="tocitem" href="../parameters/">Parameters</a></li><li><a class="tocitem" href="../glaciers/">Glaciers</a></li><li><a class="tocitem" href="../models/">Models</a></li><li><a class="tocitem" href="../results_plotting/">Results and plotting</a></li><li><a class="tocitem" href="../api/">API</a></li></ul></li><li><span class="tocitem">Inversions</span><ul><li><a class="tocitem" href="../inversions/">Inversion types</a></li><li><a class="tocitem" href="../optimization/">Optimization</a></li><li class="is-active"><a class="tocitem" href>Sensitivity analysis</a><ul class="internal"><li><a class="tocitem" href="#Manual-adjoints"><span>Manual adjoints</span></a></li><li><a class="tocitem" href="#SciMLSensitivity"><span>SciMLSensitivity</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../contribute/">How to contribute</a></li><li><a class="tocitem" href="../changes_plans/">Ongoing changes and future plans</a></li><li><a class="tocitem" href="../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Inversions</a></li><li class="is-active"><a href>Sensitivity analysis</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Sensitivity analysis</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/ODINN-SciML/ODINN.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/ODINN-SciML/ODINN.jl/blob/main/docs/src/sensitivity.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Sensitivity-Analysis"><a class="docs-heading-anchor" href="#Sensitivity-Analysis">Sensitivity Analysis</a><a id="Sensitivity-Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Sensitivity-Analysis" title="Permalink"></a></h1><p>In this section we aim to discuss the main choices and strategies regarding sensitivity analysis within the ODINN ecosystem. Sensitivity analysis is important in order to differentiate the different ice flow simulations and enable parameter calibration during the inverse modelling stage.</p><p>ODINN currently supports two main strategies regarding the computation of model sensitivity of hybrid models combining differential equations (e.g. SIA2D) and regressors: manual adjoints and <a href="https://docs.sciml.ai/SciMLSensitivity/">SciMLSensitivity.jl</a>.</p><h2 id="Manual-adjoints"><a class="docs-heading-anchor" href="#Manual-adjoints">Manual adjoints</a><a id="Manual-adjoints-1"></a><a class="docs-heading-anchor-permalink" href="#Manual-adjoints" title="Permalink"></a></h2><p>ODINN includes an implementation of both discrete and continuous adjoint methods (see [<a href="../references/#sapienza_differentiable_2024">7</a>] for a complete overview of these different methods). In both cases, the adjoint variable is computed as the solution of a time reversed differential equation. The adjoint state variable is then used to efficiently compute the gradient of a prescribed loss function.</p><p>For the SIA2D equation, the iceflow equations can be written as</p><p class="math-container">\[    \frac{\partial H}{\partial t}
    =
    \dot b
    +
    \nabla \cdot
    \left(
    D(H, \nabla S)
    \nabla S
    \right)\]</p><p>where <span>$D$</span> is a diffusivity term (see [<a href="../references/#cuffey_physics_2010">8</a>] for more information). Given a loss function <span>$L(\theta)$</span> (see the <a href="../optimization/">Optimization</a> section), the adjoint variable <span>$\lambda$</span> is defined as the solution of the following partial differential equation:</p><p class="math-container">\[    \frac{\partial \lambda}{\partial t}
    =
    - \nabla \cdot \left( D \nabla \lambda \right)
    + \frac{\partial D}{\partial H} \nabla S \cdot \nabla \lambda
    - \nabla \cdot \left( \frac{\partial D}{\partial (\nabla H)} \nabla S \cdot \nabla \lambda \right)
    - \frac{\partial \ell}{\partial H}\]</p><p>with final condition <span>$\lambda(x,y,t_1) = 0$</span> and <span>$\lambda |_{\partial \Omega} \equiv 0$</span>. The gradient of the loss function <span>$L(\theta)$</span> with respect to the parameter <span>$\theta$</span> then can be computed using the following expression:</p><p class="math-container">\[    \frac{dL}{d\theta_i}
    =
    - \iint
    \frac{\partial D}{\partial \theta_i} \nabla S \cdot \nabla \lambda\, \mathrm{d}t\, \mathrm{d}\Omega
    +
    \iint \frac{\partial \ell}{\partial \theta_i}\, \mathrm{d}t\, \mathrm{d}\Omega\]</p><p>The integration of the adjoint equation can be performed using the discrete adjoint (discretize-then-differentiate) or the continuous adjoint (differentiate-then-discretize). Both types of adjoints are implemented as an <code>AbstractAdjointMethod</code>:</p><ul><li><code>DiscreteAdjoint()</code>: The discrete adjoint is a very simple adjoint that uses an explicit Euler scheme to solve the adjoint ODE. The timestep is prescribed by the frequency at which the results are saved in the forward run. It is usually set to one month.</li><li><code>ContinuousAdjoint()</code>: With this adjoint method, the adjoint ODE is treated and solved as a standard ODE using SciMLSensitivity. The VJP with respect to the ice thickness of the ice flow equation (e.g. <code>SIA2D!</code>) is integrated backward in time. The gradients with respect to the parameters involved in the iceflow equation are then computed using a simple Gauss Quadrature at prescribed time steps. These time steps are determined by the Gauss Quadrature method and in a general case they are different from the time steps at which results are gathered in the forward run. This is way the adjoint solution is interpolated. For the moment only linear interpolators are supported.</li></ul><p>The default choice for the manual adjoint is <code>ContinuousAdjoint()</code>, which relies on <code>DifferentialEquations.jl</code> for solving the reverse adjoint equations, then providing better error control on the computation of the gradients.</p><h3 id="Computing-the-VJPs-inside-the-solver"><a class="docs-heading-anchor" href="#Computing-the-VJPs-inside-the-solver">Computing the VJPs inside the solver</a><a id="Computing-the-VJPs-inside-the-solver-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-the-VJPs-inside-the-solver" title="Permalink"></a></h3><p>When evaluating the reverse differential equations, vector-Jacobian products (VJPs) need to be evaluated at every given timestep. The computation of these VJPs can be efficiently be computed using automatic differentiation. ODINN provides manual implementations of the pullback operations required to compute these VJPs, together with the interphase to compute this VJPs using the native Julia automatic differentiation libraries. The VJP methods in ODINN are implemented as concrete types of <code>AbstractVJPMethod</code>:</p><ul><li><code>EnzymeVJP()</code>: The Enzyme VJPs rely on <a href="https://enzymead.github.io/Enzyme.jl/"><code>Enzyme.jl</code></a> to compute the VJPs of the iceflow equation. It corresponds to the true VJP of the numerical code.</li><li><code>DiscreteVJP()</code>: This is a manual implementation of what the Enzyme VJP does. Equations were derived manually by differentiating the iceflow equation.</li><li><code>ContinuousVJP()</code>: In the special case of <code>SIA2D!</code>, as we are dealing with a diffusion equation, a continuous in space VJP can be derived by integrating by parts the SIA equation. It is then discretized after differentiation.</li></ul><h2 id="SciMLSensitivity"><a class="docs-heading-anchor" href="#SciMLSensitivity">SciMLSensitivity</a><a id="SciMLSensitivity-1"></a><a class="docs-heading-anchor-permalink" href="#SciMLSensitivity" title="Permalink"></a></h2><p>Gradients can also be computed using <a href="https://docs.sciml.ai/SciMLSensitivity/">SciMLSensitivity.jl</a>. It enables to automate the computation of the adjoint method and the VJPs (Vector-Jacobian Products), done using automatic differentiation via <code>Enzyme.jl</code>.</p><p>In order to ensure end-to-end differentiability of the whole model using <code>Enzyme.jl</code>, special attention needs to be taken in terms of code style and type stability. For this, we leverage the adjoint capabilities of <code>SciMLSensitivity.jl</code> from the SciML ecosystem.</p><p>Here, we compile the main considerations and things that need to be taken into account when developing differentiable code within ODINN:</p><ul><li><strong>Ensure and test type stability</strong>. All new functions and types need to be type stable. This is crucial for them to be differentiable with <a href="https://enzymead.github.io/Enzyme.jl/stable/"><code>Enzyme.jl</code></a>. This is mainly implemented in tests using <code>JET.@test_opt</code>, a macro from the <a href="https://aviatesk.github.io/JET.jl/stable/"><code>JET.jl</code></a> package that performs static analysis on Julia code to detect potential type instabilities, method errors, or other issues at compile time. In particular, structures with abstract fields must use parametric types.</li><li><strong>Make sure that the input variables of the ice flow equation (e.g. <code>SIA2D!</code>) are not mutated</strong>. As calls to <code>Enzyme.jl</code> in <code>SciMLSensitivity.jl</code> use <a href="https://enzymead.github.io/Enzyme.jl/stable/api/#EnzymeCore.Const"><code>Enzyme.Const</code></a> for the input variable <code>H</code> when computing the VJP with respect to the parameters, it expects <code>H</code> to not be modified in-place. A typical example is <code>SIA2D!</code> where in the first lines, <code>H</code> is copied even though this is an in-place implementation because we need to clip the negative values of the input variable <code>H</code>. Failing to respect this constraint will result in the following error:</li></ul><div class="admonition is-danger" id="ERROR-9f947f2ce854abe8"><header class="admonition-header">ERROR<a class="admonition-anchor" href="#ERROR-9f947f2ce854abe8" title="Permalink"></a></header><div class="admonition-body"><pre><code class="nohighlight hljs">Constant memory is stored (or returned) to a differentiable variable.
As a result, Enzyme cannot provably ensure correctness and throws this error.
This might be due to the use of a constant variable as temporary storage for active memory (https://enzyme.mit.edu/julia/stable/faq/#Runtime-Activity).
If Enzyme should be able to prove this use non-differentiable, open an issue!
To work around this issue, either:
    a) rewrite this variable to not be conditionally active (fastest, but requires a code change), or
    b) set the Enzyme mode to turn on runtime activity (e.g. autodiff(set_runtime_activity(Reverse), ...) ). This will maintain correctness, but may slightly reduce performance.</code></pre></div></div><ul><li><strong>The <a href="https://docs.sciml.ai/DiffEqDocs/stable/types/ode_types/"><code>ODEProblem</code></a> needs to be defined out of the function that is being differentiated</strong>. We use <code>remake(iceflow_prob; p=container)</code> to define a new <code>ODEProblem</code> and the solver will use the parameters defined in <code>container</code>.</li><li><strong>No closures are used to provide the <code>Simulation</code> object to the iceflow equation</strong>. The <a href="https://github.com/SciML/SciMLStructures.jl">SciMLStructures.jl</a> package has been especially implemented for this use case where one wants to provide both a vector of parameters to optimize, and a complex struct. This struct is designed to store some intermediate results through a cache and simulation parameters that are used to store physical quantities. The documentation provides <a href="https://sciml.github.io/SciMLStructures.jl/stable/example/">an example of how to implement the interface</a>. Special attention should be given to the definition of the <code>replace</code> function which should deepcopy the whole struct and zero the fields that are not used to differentiate parameters.</li><li><strong>At the loss function level, all the operations need to be out-of-place</strong> as <a href="https://fluxml.ai/Zygote.jl/stable/"><code>Zygote.jl</code></a> is used to differentiate this part of the computational graph. This means for example that one cannot affect the <code>results</code> in <code>simulation</code> and this has to be done outside of the functions that are called by <code>Zygote.gradient</code>. The error raised in case an in-place affectation is done is rather explicit.</li><li>Parts of the computational graph are not needed to compute the true gradient and they can be bypassed thanks to the <code>@ignore_derivatives</code> macro. This is the case for example of the reference ice thickness.</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../optimization/">« Optimization</a><a class="docs-footer-nextpage" href="../contribute/">How to contribute »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Wednesday 20 August 2025 11:31">Wednesday 20 August 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
